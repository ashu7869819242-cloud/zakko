rules_version = '2';

/**
 * Firestore Security Rules — Campus Canteen
 * 
 * These rules enforce:
 * 1. Users can only read their own profile (writes go through /api/users/register)
 * 2. Users can only read their own orders (writes go through /api/orders)
 * 3. Users can only read their own wallet transactions (writes go through /api/wallet)
 * 4. Menu items are publicly readable (no auth needed to browse)
 * 5. All writes to users/orders/walletTransactions go through Admin SDK (server-side)
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Users ──────────────────────────────────────
    // Read: only the authenticated user can read their own document
    // Write: DENY — profile creation goes through /api/users/register (Admin SDK)
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Server-side only via Admin SDK
    }

    // ─── Menu Items ─────────────────────────────────
    // Read: public (anyone can browse the menu)
    // Write: DENY — managed via /api/admin/menu (Admin SDK)
    match /menuItems/{itemId} {
      allow read: if true;
      allow write: if false; // Server-side only via Admin SDK
    }

    // ─── Orders ─────────────────────────────────────
    // Read: only the authenticated user can read their own orders
    // Write: DENY — order creation goes through /api/orders (Admin SDK)
    match /orders/{orderId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false; // Server-side only via Admin SDK
    }

    // ─── Wallet Transactions ────────────────────────
    // Read: owner, sender, or receiver can read (supports P2P transfers)
    // Write: DENY — all wallet ops go through /api/wallet (Admin SDK)
    match /walletTransactions/{txnId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
      allow write: if false; // Server-side only via Admin SDK
    }

    // ─── Payments ───────────────────────────────────
    // Read: only the owner can read their payment records
    // Write: DENY — payment creation goes through /api/razorpay/verify (Admin SDK)
    match /payments/{paymentId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false; // Server-side only via Admin SDK
    }

    // ─── Settings ───────────────────────────────────
    // Read: public (canteen status is visible to all authenticated users)
    // Write: DENY — managed via /api/admin/settings (Admin SDK)
    match /settings/{docId} {
      allow read: if true;
      allow write: if false; // Server-side only via Admin SDK
    }

    // ─── Catch-all ──────────────────────────────────
    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
